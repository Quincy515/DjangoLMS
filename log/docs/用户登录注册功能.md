

ç”¨æˆ·æ³¨å†Œ
----

### 1\. åœ¨ templates ä¸­å†™å…¥register.html

### 2\. åœ¨ url ä¸­åš register çš„é…ç½®

 é¦–å…ˆåœ¨ users ä¸­æ·»åŠ  RegisterView ç±» ç»§æ‰¿è‡ª View

```python
from django.views.generic.base import View

class RegisterView(View):
    def get(self, request):
        return render(request, "register.html", {})
```

ç„¶ååœ¨ URL ä¸­æ·»åŠ  register é…ç½®

```python
from users.views import LoginView, RegisterView

urlpatterns = [
    url(r'^xadmin/', xadmin.site.urls),
    url('^$', TemplateView.as_view(template_name="index.html"), name="index"),
    # url('^login/$', TemplateView.as_view(template_name="login.html"), name="login")
    # url('^login/$', user_login, name="login")
    url('^login/$', LoginView.as_view(), name="login"),
    url('^register/$', RegisterView.as_view(), name="register")
]
```

è¿™æ ·å°±å¯ä»¥è®¿é—®æˆåŠŸäº†

### 3\. æ”¹å˜ html ä¸­çš„æ³¨å†ŒæŒ‰é’®çš„è·³è½¬

```html
<!--ç™»å½•åè·³è½¬-->
                    {% if request.user.is_authenticated %}
                        <div class="personal">
                            <dl class="user fr">
                                <dd>bobby<img class="down fr" src="/static/images/top_down.png"/></dd>
                                <dt><img width="20" height="20" src="/static/media/image/2016/12/default_big_14.png"/></dt>
                            </dl>
                            <div class="userdetail">
                            	<dl>
	                                <dt><img width="80" height="80" src="/static/media/image/2016/12/default_big_14.png"/></dt>
	                                <dd>
	                                    <h2>django</h2>
	                                    <p>bobby</p>
	                                </dd>
                                </dl>
                                <div class="btn">
	                                <a class="personcenter fl" href="usercenter-info.html">è¿›å…¥ä¸ªäººä¸­å¿ƒ</a>
	                                <a class="fr" href="/logout/">é€€å‡º</a>
                                </div>
                            </div>
                        </div>
                        {% else %}
                        <a style="color:black" class="fr registerbtn" href="{% url 'register' %}">æ³¨å†Œ</a>
                        <a style="color:black" class="fr loginbtn" href="{% url 'login' %}">ç™»å½•</a>
                    {% endif %}
```

### 4\. static è·¯å¾„æ–‡ä»¶åœ°å€è½¬æ¢

ä¿®æ”¹register.htmlä¸­cssã€jsã€imagesã€imgã€mediaç­‰æ–‡ä»¶çš„åœ°å€

```html
<html>
{% load staticfiles %}
<head>
    <meta charset="UTF-8">
    <meta name="renderer" content="webkit">
    <meta http-equiv="X-UA-Compatible" content="IE=Edge,chrome=1" >
    <title>æ…•å­¦åœ¨çº¿æ³¨å†Œ</title>
    <link rel="stylesheet" type="text/css" href="{% static 'css/reset.css' %}">
    <link rel="stylesheet" type="text/css" href="/static/css/login.css">

</head>
```

é¦–å…ˆ

```python
{% load staticfiles %}
```

```html
<link rel="stylesheet" type="text/css" href="{% static 'css/reset.css' %}">
<link rel="stylesheet" type="text/css" href="/static/css/login.css">
```

static ç›¸å½“äºä¸€ä¸ªå‡½æ•°ï¼Œ åé¢çš„å‚æ•°æ˜¯ç›¸å¯¹è·¯å¾„ï¼Œ ä¼šæ ¹æ®settingä¸‹çš„staticç›®å½•çš„é…ç½®å»æ‰¾ ç›¸å¯¹è·¯å¾„

```html
<script src="{% static 'js/jquery.min.js' %}" type="text/javascript"></script>
<script src="{% static 'js/unslider.js' %}" type="text/javascript"></script>
<script src="{% static 'js/validateDialog.js' %}"  type="text/javascript"></script>
<script src="{% static 'js/login.js' %}"  type="text/javascript"></script>
```

### 5\. Django-simple-captcha

django éªŒè¯ç çš„æ¡†æ¶æ’ä»¶. ç‰ˆæœ¬0.4.6 

1. Download `django-simple-captcha` using [pip](http://pypi.python.org/pypi/pip) by running: `pipÂ installÂ Â django-simple-captcha`
2. Add `captcha` to the `INSTALLED\_APPS` in your `settings.py`
3. Run `pythonÂ manage.pyÂ syncdb` (or `pythonÂ manage.pyÂ migrate` if you are managing database migrations via South) to create the required database tables
4. Add an entry to your `urls.py`:

      url(r'^captcha/', include('captcha.urls')),

```python
pip install  django-simple-captcha==0.4.6
```

```python
from django.conf.urls import url, include
from django.contrib import admin
from django.views.generic import TemplateView
import xadmin

# from users.views import user_login
from users.views import LoginView, RegisterView

urlpatterns = [
    url(r'^xadmin/', xadmin.site.urls),
    url('^$', TemplateView.as_view(template_name="index.html"), name="index"),
    # url('^login/$', TemplateView.as_view(template_name="login.html"), name="login")
    # url('^login/$', user_login, name="login")
    url('^login/$', LoginView.as_view(), name="login"),
    url('^register/$', RegisterView.as_view(), name="register"),
    url(r'^captcha/', include('captcha.urls')),
]
```

```python
makemigrations
migrate
```

### 6\. åº”ç”¨åˆ° users/forms.py ä¸­

```python
from django import forms
from captcha.fields import CaptchaField

class LoginForm(forms.Form):
    username = forms.CharField(required=True)
    password = forms.CharField(required=True, min_length=5)


class RegisterForm(forms.Form):
    email = forms.EmailField(required=True)
    password = forms.CharField(required=True, min_length=5)
    captcha = CaptchaField()
```

### 7\. åœ¨ RegisterView ä¸­ï¼Œå®ä¾‹åŒ– RegisterFormï¼Œç„¶åä¼ é€’åˆ°register.htmlä¸­

```python
from .forms import LoginForm, RegisterForm
class RegisterView(View):
    def get(self, request):
        register_form = RegisterForm()
        return render(request, "register.html", {'register_form': register_form})
```

### 8\. register.html ä¸­çš„åº”ç”¨

```html
<div class="form-group marb8 captcha1 ">
    <label>éªŒ&nbsp;è¯&nbsp;ç </label>
    {{ register_form.captcha }}
{#  <img src="/captcha/image/2f3f82e5f7a054bf5caa93b9b0bb6cc308fb7011/" alt="captcha" class="captcha" /> #}
{#  <input id="id_captcha_0" name="captcha_0" type="hidden" value="2f3f82e5f7a054bf5caa93b9b0bb6cc308fb7011" /> #}
{#  <input autocomplete="off" id="id_captcha_1" name="captcha_1" type="text" />#}
</div>
```

```html
{{ register_form.captcha }}
```

è‡ªåŠ¨ç”Ÿæˆä¸‹é¢çš„ä»£ç 

```html
<img src="/captcha/image/2f3f82e5f7a054bf5caa93b9b0bb6cc308fb7011/" alt="captcha" class="captcha" />
<input id="id_captcha_0" name="captcha_0" type="hidden" value="2f3f82e5f7a054bf5caa93b9b0bb6cc308fb7011" />
<input autocomplete="off" id="id_captcha_1" name="captcha_1" type="text" />
```

### 9\. RegisterView ä¸­ç¼–å†™poståå°é€»è¾‘

```python
class RegisterView(View):
    def get(self, request):
        register_form = RegisterForm()
        return render(request, "register.html", {'register_form': register_form})

    def post(self, request):
        register_form = RegisterForm(request.POST)
        if register_form.is_valid():
            pass
```

register.htmlä¸­input çš„ name å¾ˆé‡è¦

```html
<form id="email_register_form" method="post" action={% url 'register' %} autocomplete="off">
<div class="form-group marb20 ">
    <label>é‚®&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;ç®±</label>
    <input  type="text" id="id_email" name="email" value="None" placeholder="è¯·è¾“å…¥æ‚¨çš„é‚®ç®±åœ°å€" />
</div>
<div class="form-group marb8 ">
    <label>å¯†&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;ç </label>
    <input type="password" id="id_password" name="password"  value="None" placeholder="è¯·è¾“å…¥6-20ä½éä¸­æ–‡å­—ç¬¦å¯†ç " />
</div>
<div class="form-group marb8 captcha1 ">
    <label>éªŒ&nbsp;è¯&nbsp;ç </label>
    {{ register_form.captcha }}
</div>
{% csrf_token %}
</form>
```

users/forms.py éªŒè¯ç é”™è¯¯

```python
class RegisterForm(forms.Form):
    email = forms.EmailField(required=True)
    password = forms.CharField(required=True, min_length=5)
    captcha = CaptchaField(error_messages={"invalid": u"éªŒè¯ç é”™è¯¯"})
```

å–åˆ°formæäº¤çš„è´¦å·å¯†ç ï¼Œ

 å®ä¾‹åŒ–UserProfile()

 user\_name å’Œ emailèµ‹å€¼

 å¯†ç çš„æ˜æ–‡åŠ å¯†

 user\_profile.save()ä¿å­˜åˆ°æ•°æ®åº“ä¸­

```python
from django.contrib.auth.hashers import make_password
class RegisterView(View):
    def get(self, request):
        register_form = RegisterForm()
        return render(request, "register.html", {'register_form': register_form})

    def post(self, request):
        register_form = RegisterForm(request.POST)
        if register_form.is_valid():
            user_name = request.POST.get("username", "")
            pass_word = request.POST.get("password", "")
            user_profile = UserProfile()
            user_profile.username = user_name
            user_profile.email = user_name
            user_profile.password = make_password(pass_word)
            user_profile.save()
```

### 10\. å‘é€æ¿€æ´»é“¾æ¥åˆ°é‚®ç®±çš„é€»è¾‘

åœ¨ app ä¸‹æ–°å»ºä¸€ä¸ªpython package å‘é€é‚®ä»¶çš„ åŸºç¡€æ–‡ä»¶ utilsï¼Œæ–°å»ºä¸€ä¸ªå‘é€é‚®ä»¶å‡½æ•°email\_send.py

ä¹‹å‰åœ¨ apps/users/models.pyä¸­å®šä¹‰äº†é‚®ç®±éªŒè¯å‡½æ•°EmailVerifyRecord()

```python
class EmailVerifyRecord(models.Model):
    code = models.CharField(max_length=20, verbose_name=u"éªŒè¯ç ")
    email = models.EmailField(max_length=50, verbose_name=u"é‚®ç®±")
    send_type = models.CharField(choices=(("register", u"æ³¨å†Œ"), ("forget", u"æ‰¾å›å¯†ç ")), max_length=10, verbose_name=u"éªŒè¯ç ç±»å‹")
    send_time = models.DateTimeField(default=datetime.now, verbose_name=u"å‘é€æ—¶é—´")
    # datetime.now()ä¸å»æ‹¬å·æ˜¯ç¼–è¯‘çš„æ—¶é—´ï¼Œå»æ‹¬å·æ˜¯classå®ä¾‹åŒ–çš„æ—¶å€™

    class Meta:
        verbose_name = u"é‚®ç®±éªŒè¯ç "
        verbose_name_plural = verbose_name

    def __unicode__(self):
        return '{0}({1})'.format(self.code, self.email)
```

éšæœºç”Ÿæˆå­—ç¬¦ä¸²

å‘é€æ³¨å†Œé‚®ä»¶ï¼ˆé…ç½®å‘é€è€…ï¼‰setting.py

```python
EMAIL_HOST = "smtp.163.com"
EMAIL_PORT = 25
EMAIL_HOST_USER = "custertian@163.com"
EMAIL_HOST_PASSWORD = "root1234"
EMAIL_USE_TLS = False
EMAIL_FROM = "custertian@163.com"
```

apps/utils/email\_send.py

```python
from random import Random
from django.core.mail import send_mail

from users.models import EmailVerifyRecord
from MxOnline.settings import EMAIL_FROM

def random_str(randomlength=8):
    str = ''
    chars = 'AaBbCcDdEeFfGgHhIiJjKkLlMmNnOoPpQqRrSsTtUuVvWwXxYyZz0123456789'
    length = len(chars) - 1
    random = Random()
    for i in range(randomlength):
        str += chars[random.randint(0, length)]
    return str


def send_register_email(email, send_type="register"):
    email_record = EmailVerifyRecord()
    code = random_str(16)
    email_record.code = code
    email_record.email = email
    email_record.send_type = send_type
    email_record.save()

    email_title = ""
    email_body = ""

    if send_type == "register"
        email_title = "ç‰§å­¦åœ¨çº¿ç½‘æ³¨å†Œæ¿€æ´»é“¾æ¥"
        email_body = "è¯·ç‚¹å‡»ä¸‹é¢çš„é“¾æ¥æ¿€æ´»ä½ çš„è´¦å·:http://127.0.0.1:8000/activate/{0}".format(code)
        send_status = send_mail(email_title, email_body, EMAIL_FROM, [email])
        if send_status:
            pass
```

åœ¨apps/users/views.pyä¸­è°ƒç”¨

```python
from utils.email_send import send_register_email
class RegisterView(View):
    def get(self, request):
        register_form = RegisterForm()
        return render(request, "register.html", {'register_form': register_form})

    def post(self, request):
        register_form = RegisterForm(request.POST)
        if register_form.is_valid():
            user_name = request.POST.get("email", "")
            pass_word = request.POST.get("password", "")
            user_profile = UserProfile()
            user_profile.username = user_name
            user_profile.email = user_name
            user_profile.password = make_password(pass_word)
            user_profile.save()

            send_register_email(user_name, "register")
            return render(request, "login.html")
        else:
            return render(request, "register.html", {"register_form": register_form})
```

### 11\. åœ¨å‰ç«¯æ˜¾ç¤ºé”™è¯¯ä¿¡æ¯

```python
<div class="tab-form">
                    <form id="email_register_form" method="post" action={% url 'register' %} autocomplete="off">
                        <input type='hidden' name='csrfmiddlewaretoken' value='gTZljXgnpvxn0fKZ1XkWrM1PrCGSjiCZ' />
                        <div class="form-group marb20 {% if register_form.errors.email %}errorput{% endif %}">
                            <label>é‚®&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;ç®±</label>
                            <input  type="text" id="id_email" name="email" value="{{ register_form.email.value }}" placeholder="è¯·è¾“å…¥æ‚¨çš„é‚®ç®±åœ°å€" />
                        </div>
                        <div class="form-group marb8 {% if register_form.errors.password %}errorput{% endif %}">
                            <label>å¯†&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;ç </label>
                            <input type="password" id="id_password" name="password"  value="{{ register_form.password.value }}" placeholder="è¯·è¾“å…¥6-20ä½éä¸­æ–‡å­—ç¬¦å¯†ç " />
                        </div>
                        <div class="form-group marb8 captcha1 {% if register_form.errors.captcha %}errorput{% endif %}">
                            <label>éªŒ&nbsp;è¯&nbsp;ç </label>
                            {{ register_form.captcha }}
                        </div>
                        <div class="error btns" id="jsEmailTips">{% for key, error in register_form.errors.items %}{{ error }}{% endfor %}{{ msg }}</div>
                        <div class="auto-box marb8">
                        </div>
                        <input class="btn btn-green" id="jsEmailRegBtn" type="submit" value="æ³¨å†Œå¹¶ç™»å½•" />
                    <input type='hidden' name='csrfmiddlewaretoken' value='5I2SlleZJOMUX9QbwYLUIAOshdrdpRcy' />
                        {% csrf_token %}
                    </form>
                </div>
```

### 12\. é‚®ä»¶çš„æ¿€æ´»

æ•°æ®åº“è¡¨users\_userprofileä¸­æœ‰ä¸ªå­—æ®µis\_activate,é»˜è®¤ä¸ºtrueåœ¨ç”¨æˆ·æ³¨å†Œçš„æ—¶å€™æ”¹ä¸ºfalse

```python
user_profile.is_active = False  # è¡¨æ˜ç”¨æˆ·è¿˜æ²¡æœ‰æ¿€æ´»ï¼Œç‚¹å‡»é‚®ä»¶é“¾æ¥ä¹‹åæ‰ä¼šæ¿€æ´» 
```

åœ¨urlä¸­å¤„ç†é‚®ä»¶çš„æ¿€æ´»

    è¯·ç‚¹å‡»ä¸‹é¢çš„é“¾æ¥æ¿€æ´»ä½ çš„è´¦å·:http://127.0.0.1:8000/activate/FTXMDbvNifJW5wEa

    é“¾æ¥çš„åé¢æ˜¯ä¸ªéšæœºå­—ç¬¦ä¸²ï¼Œé…ç½®urlæå–éšæœºçš„å˜é‡

    urlä¸­çš„å˜é‡ï¼Œ

    æ·»åŠ ä¸€ä¸ªæ‹¬å·

    ç„¶åä¸€ä¸ªé—®å·

    ä¸€ä¸ªå¤§å†™çš„P - æå–ä¸€ä¸ªå˜é‡å½“ä½œå‚æ•°

    <> - å°–æ‹¬å·é‡Œé¢ä»»æ„å‘½å - å«active_code

    \ - æ­£åˆ™è¡¨è¾¾å¼ç¬¦å·

    .* - å…¨éƒ¨ç»™æ‹¿å‡ºæ¥

    å…¨éƒ¨æ‹¿å‡ºæ¥ï¼Œç„¶åè®©å…¥active_codeè¿™ä¸ªå‚æ•°é‡Œé¢æ¥

```python
from users.views import LoginView, RegisterView, ActiveUserView
url(r'^active/(?P<active_code>.*)/$', ActiveUserView.as_view(), name="user_active")
```

å†æ¥ä¹¦å†™viewæ·»åŠ class ActiveUserView - ç¬¬ä¸‰ä¸ªå‚æ•°åç§°è¦å’Œurlä¸­å‚æ•°åç§°ç›¸åŒ

```python

class ActiveUserView(View):
    def get(self, request, active_code):
```

æŸ¥è¯¢ä¸‹è®°å½•æ˜¯å¦å­˜åœ¨

```python
from .models import UserProfile, EmailVerifyRecord
class ActiveUserView(View):
    def get(self, request, active_code):
        all_records = EmailVerifyRecord.objects.filter(code=active_code)
        if all_records:
            for record in all_records:
                email = record.email
                user = UserProfile.objects.get(email=email)
                user.is_active = True
                user.save()
        return render(request, "login.html")
```

åœ¨ä¿®æ”¹loginViewçš„é€»è¾‘

```python
class LoginView(View):
    def get(self, request):
        return render(request, "login.html", {})

    def post(self, request):
        login_form = LoginForm(request.POST)
        if login_form.is_valid():
            user_name = request.POST.get("username", "")
            pass_word = request.POST.get("password", "")
            user = authenticate(username=user_name, password=pass_word)  # é€šè¿‡useræ˜¯ä¸€ä¸ªå¯¹è±¡ï¼Œå¦åˆ™ä¸ºnull
            if user is not None:
                if user.is_active:
                    login(request, user)
                    return render(request, "index.html")
                else:
                    return render(request, "login.html", {"msg": "é‚®ç®±æœªæ¿€æ´»ï¼"})
            else:
                return render(request, "login.html", {"msg": "ç”¨æˆ·åæˆ–å¯†ç é”™è¯¯ï¼"})
        else:
            return render(request, "login.html", {"login_form": login_form})

```

é—ç•™é—®é¢˜ 1ï¼š

åˆ¤æ–­é‚®ç®±æ˜¯å¦å­˜åœ¨

```python
class RegisterView(View):
    def get(self, request):
        register_form = RegisterForm()
        return render(request, "register.html", {'register_form': register_form})

    def post(self, request):
        register_form = RegisterForm(request.POST)
        if register_form.is_valid():
            user_name = request.POST.get("email", "")
            if UserProfile.objects.filter(email=user_name):  # åˆ¤æ–­é‚®ç®±æ˜¯å¦å­˜åœ¨
                return render(request, "register.html", {"register_form": register_form, "msg": "ç”¨æˆ·å·²ç»å­˜åœ¨"})
            pass_word = request.POST.get("password", "")
            user_profile = UserProfile()
            user_profile.username = user_name
            user_profile.email = user_name
            user_profile.is_active = False  # è¡¨æ˜ç”¨æˆ·è¿˜æ²¡æœ‰æ¿€æ´»ï¼Œç‚¹å‡»é‚®ä»¶é“¾æ¥ä¹‹åæ‰ä¼šæ¿€æ´»
            user_profile.password = make_password(pass_word)
            user_profile.save()

            send_register_email(user_name, "register")
            return render(request, "login.html")
        else:
            return render(request, "register.html", {"register_form": register_form})
```

é—ç•™é—®é¢˜ 2ï¼š

é‚®ç®±æ¿€æ´» ActiveUserViewå¦‚æœé‚®ç®±å­˜åœ¨æ¿€æ´»ç”¨æˆ·ï¼Œå¦‚æœé‚®ç®±ä¸å­˜åœ¨

æ–°å»ºä¸€ä¸ªhtmlé¡µé¢ active\_fail.html

```html
<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Title</title>
</head>
<body>
<p>é“¾æ¥ğŸ”—å¤±æ•ˆ</p>
</body>
</html>
```

```python
class ActiveUserView(View):
    def get(self, request, active_code):
        all_records = EmailVerifyRecord.objects.filter(code=active_code)
        if all_records:
            for record in all_records:
                email = record.email
                user = UserProfile.objects.get(email=email)
                user.is_active = True
                user.save()
        else:
            return render(request, "active_fail.html")
        return render(request, "login.html")
```

### 13\. æ‰¾å›å¯†ç 

forgetpwd.html

æ·»åŠ url

```python
from users.views import LoginView, RegisterView, ActiveUserView, ForgetPwdView
url(r'^forget/$', ForgetPwdView.as_view(), name="forget_pwd")
```

å’Œé…ç½®ForgetPwdViewå‡½æ•°

```python
class ForgetPwdView(View):
    def get(self, request):
        return render(request, "forgetpwd.html", {})
```

åœ¨login.htmlä¸­ä¿®æ”¹å¿˜è®°å¯†ç éƒ¨åˆ†

```html
<div class="auto-box marb38">
    <a class="fr" href="forgetpwd.html">å¿˜è®°å¯†ç ï¼Ÿ</a>
</div>
```

ä¿®æ”¹ä¸ºï¼š

```html
<a class="fr" href="{% url 'forget_pwd' %}">å¿˜è®°å¯†ç ï¼Ÿ</a>
```

ä¿®æ”¹forgetpwd.htmlçš„æœ¬åœ°æ–‡ä»¶è·¯å¾„ï¼š

```html
<link rel="stylesheet" type="text/css" href="../css/reset.css">
```

ä¿®æ”¹ä¸ºï¼š åœ¨è°ƒç”¨staticä¹‹å‰è¦å…ˆload staticfiles

```html
{% load staticfiles %}

<link rel="stylesheet" type="text/css" href="{% static 'css/reset.css'%}">
```

éªŒè¯ç  åœ¨forms.py ä¸­æ·»åŠ  ForgetForm

```python
class ForgetForm(forms.Form):
    email = forms.EmailField(required=True)
    captcha = CaptchaField(error_messages={"invalid": u"éªŒè¯ç é”™è¯¯"})
```

åœ¨views.pyé‡Œé…ç½®

é¦–å…ˆimport è¿›æ¥

å®ä¾‹åŒ–è¿™ä¸ªform

æŠŠformä¼ é€’åˆ°htmlé¡µé¢ä¸­æ¥

```python
from .forms import LoginForm, RegisterForm, ForgetForm

class ForgetPwdView(View):
    def get(self, request):
        forget_form = ForgetForm()
        return render(request, "forgetpwd.html", {"forget_form": forget_form})
```

ç„¶åé…ç½®htmlé¡µé¢

```html
<div class="form-group captcha1 marb38">
    <label>éªŒ&nbsp;è¯&nbsp;ç </label>
    {{ forget_form.captcha }}
</div>
```

ç„¶åå†™POSTåå°é€»è¾‘

htmlä¸­inputæ ‡ç­¾çš„name ä¸€å®šè¦å’Œåå°ç›¸åŒ

```html
 <div class="form-group marb20 ">
    <label>å¸&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;å·</label>
    <input type="text" id="account" name="email" value="None" placeholder="é‚®ç®±" />
</div>
```

html ä¸­ from çš„ method=â€œPOSTâ€ action=â€œ{% url â€˜forget\_pwd' %}"

```html
<form id="jsFindPwdForm" method="post" action={% url 'forget_pwd' %} autocomplete="off">
```

æäº¤formçš„æ—¶å€™è¦åŠ ä¸Š csrf\_token

```html
{% csrf_token %}
```

```html
<div class="fl form-box">
                <h2>å¿˜è®°å¯†ç </h2>
                <form id="jsFindPwdForm" method="post" action={% url 'forget_pwd' %} autocomplete="off">
                    <input type='hidden' name='csrfmiddlewaretoken' value='mymQDzHWl2REXIfPMg2mJaLqDfaS1sD5' />
                    <div class="form-group marb20 ">
                        <label>å¸&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;å·</label>
                        <input type="text" id="account" name="email" value="None" placeholder="é‚®ç®±" />
                    </div>
                    <div class="form-group captcha1 marb38">
                        <label>éªŒ&nbsp;è¯&nbsp;ç </label>
                        {{ forget_form.captcha }}
                    </div>
                    <div class="error btns" id="jsForgetTips"></div>
                    <input type="hidden" name="sms_type" value="1">
                    <input class="btn btn-green" id="jsFindPwdBtn" type="submit" value="æäº¤" />
                    <p class="form-p" style="bottom:40px;">æ‚¨è¿˜å¯ä»¥<a href="{% url 'login' %}"> [ç›´æ¥ç™»å½•]</a></p>
                <input type='hidden' name='csrfmiddlewaretoken' value='5I2SlleZJOMUX9QbwYLUIAOshdrdpRcy' />
                    {% csrf_token %}
                </form>
            </div>
```

æ‰¾å›å¯†ç åŠŸèƒ½å®ç°

ç”Ÿæˆéšæœºå­—ç¬¦ä¸²

å‘é€é‚®ä»¶

ä½¿ç”¨ä¹‹å‰çš„å‡½æ•°email\_send.py

```python
def send_register_email(email, send_type="register"):
    email_record = EmailVerifyRecord()
    code = random_str(16)
    email_record.code = code
    email_record.email = email
    email_record.send_type = send_type
    email_record.save()

    email_title = ""
    email_body = ""

    if send_type == "register":
        email_title = "ç‰§å­¦åœ¨çº¿ç½‘æ³¨å†Œæ¿€æ´»é“¾æ¥ğŸ”—ğŸ”—ğŸ”—"
        email_body = "è¯·ç‚¹å‡»ä¸‹é¢çš„é“¾æ¥æ¿€æ´»ä½ çš„è´¦å·:http://127.0.0.1:8000/active/{0}".format(code)
        send_status = send_mail(email_title, email_body, EMAIL_FROM, [email])
        if send_status:
            pass
    elif send_type == "forget":
        email_title = "ç‰§å­¦åœ¨çº¿ç½‘å¯†ç é‡ç½®é“¾æ¥ğŸ”—ğŸ”—ğŸ”—"
        email_body = "è¯·ç‚¹å‡»ä¸‹é¢çš„é“¾æ¥é‡ç½®å¯†ç :http://127.0.0.1:8000/reset/{0}".format(code)
        send_status = send_mail(email_title, email_body, EMAIL_FROM, [email])
        if send_status:
            pass
```

æ–°å»ºä¸€ä¸ªhtmlé¡µé¢ send\_success.html

```html
<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>YaKç‰§å­¦ç½‘é‚®ä»¶å‘é€æˆåŠŸ</title>
</head>
<body>
<p>é‚®ä»¶ğŸ“§å·²ç»å‘é€æˆåŠŸï¼Œè¯·æŸ¥æ”¶</p>
</body>
</html>
```

å½“é‚®ä»¶å‘é€æˆåŠŸä¹‹åè¿”å›send\_success.html

```python
class ForgetPwdView(View):
    def get(self, request):
        forget_form = ForgetForm()
        return render(request, "forgetpwd.html", {"forget_form": forget_form})

    def post(self, request):
        forget_form = ForgetForm(request.POST)
        if forget_form.is_valid():
            email = request.POST.get("email", "")
            send_register_email(email, "forget")
            return render(request, "send_success.html")
        else:
            return render(request, "forgetpwd.html", {"forget_form": forget_form})
```

æ³¨æ„postçš„æ—¶å€™ä¸€å®šè¦ **request.POST**

Forgetpwd.htmlæ˜¾ç¤ºé”™è¯¯ä¿¡æ¯

```html
<div class="error btns" id="jsForgetTips">{% for key, error in forget_form.errors.items %}{{ error }}{% endfor %}{{ msg }}</div>
```

é”™è¯¯çš„divæ·»åŠ ä¸€ä¸ªfocusæ•ˆæœ

```html
<div class="form-group marb20 {% if forget_form.errors.email %}errorput{% endif %}">
    <label>å¸&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;å·</label>
    <input type="text" id="account" name="email" value="None" placeholder="é‚®ç®±" />
</div>
```

ç”¨æˆ·å‡ºé”™ä¹‹åvalueå¾—å›å¡«å›æ¥

```html
<div class="form-group marb20 {% if forget_form.errors.email %}errorput{% endif %}">
    <label>å¸&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;å·</label>
    <input type="text" id="account" name="email" value="{{ forget_form.email.value }}" placeholder="é‚®ç®±" />
</div>
```

ç›®å‰è¿™æ ·ï¼Œé‡ç½®å¯†ç é‚®ä»¶ğŸ”—é“¾æ¥ğŸ”—å°±å¯ä»¥å‘é€æˆåŠŸäº†ï¼Œç‚¹å‡»é“¾æ¥ä¹‹åçš„é€»è¾‘ï¼š

é¦–å…ˆé…ç½®resetçš„url

å†™RestViewé€»è¾‘ã€‚å¦‚æœæŸ¥æ‰¾åˆ°ï¼š

å–å‡ºemail

ç»™ç”¨æˆ·ä¸€ä¸ªé‡ç½®å¯†ç çš„é¡µé¢ password\_reset.html

```python
class ResetView(View):
    def get(self, request, active_code):
        all_records = EmailVerifyRecord.objects.filter(code=active_code)
        if all_records:
            for record in all_records:
                email = record.email
                return render(request, "password_reset.html", {"email": email})

        else:
            return render(request, "active_fail.html")
        return render(request, "login.html")
```

ä¼ é€’å‚æ•°ï¼Œéœ€è¦çŸ¥é“å“ªä¸ªç”¨æˆ·éœ€è¦é‡ç½®å¯†ç ï¼š

```python
return render(request, "password_reset.html", {"email": email})
```

password\_reset.html:

```html
<!DOCTYPE html>
<html lang="en">
<head>
	<meta charset="UTF-8">
    <meta name="renderer" content="webkit">
    <meta http-equiv="X-UA-Compatible" content="IE=Edge,chrome=1">
	<title>å¯†ç ä¿®æ”¹</title>
	<link rel="stylesheet" type="text/css" href="/static/css/reset.css">
	<link rel="stylesheet" type="text/css" href="/static/css/animate.css">
	<link rel="stylesheet" type="text/css" href="/static/css/style.css">

<body>
<div class="wp">
    <div class="resetpassword" id="resetPwdForm">
        <h1>ä¿®æ”¹å¯†ç </h1>
        <p>å·²ç»é€šè¿‡éªŒè¯ï¼Œè¯·è®¾ç½®æ–°å¯†ç </p>
        <form id="reset_password_form" action="" method="post">
            <ul>
                <li>
                    <span class="">æ–° å¯† ç  ï¼š</span>
                    <input type="password" name="password" id="pwd" placeholder="6-20ä½éä¸­æ–‡å­—ç¬¦">
                    <i></i>
                </li>
                <input type="hidden" value="{{ email }}">
                <li>
                    <span class="">ç¡®å®šå¯†ç ï¼š</span>
                    <input type="password" name="password2" id="repwd" placeholder="6-20ä½éä¸­æ–‡å­—ç¬¦">
                    <i></i>
                </li>
                <li class="button">
                    <input type="button" value="æäº¤" onclick="reset_password_form_submit()">
                </li>
            </ul>
        </form>
    </div>
    <div class="resetpassword" id="reset_password_tips" style="display:none;">
        <h1>ä¿®æ”¹å¯†ç æˆåŠŸ,è¯·é‡æ–°ç™»å½•</h1>
        <img class="fl" src="/static/images/check2.png">
        <p class="successword">å·²ç»æˆåŠŸä¿®æ”¹å¯†ç ï¼Œè¯·é‡æ–°ç™»å½•</p>
    </div>
</div>
</body>
</html>
```

ç”¨æˆ·åœ¨ä¿®æ”¹å¯†ç ä¹‹åè¦æŠŠé‚®ç®±å‘Šè¯‰åå°ï¼Œè¦ä¸ä¸çŸ¥é“æ˜¯è°ä¿®æ”¹çš„å¯†ç ï¼šæ‰€ä»¥åŠ ä¸Š

```html
<input type="hidden" value="{{ email }}">
```

ç„¶åæŠŠReserView é…ç½®åˆ°urlä¸­

```python
from users.views import LoginView, RegisterView, ActiveUserView, ForgetPwdView, ResetView
urlpatterns = [
    url(r'^xadmin/', xadmin.site.urls),
    url('^$', TemplateView.as_view(template_name="index.html"), name="index"),
    # url('^login/$', TemplateView.as_view(template_name="login.html"), name="login")
    # url('^login/$', user_login, name="login")
    url('^login/$', LoginView.as_view(), name="login"),
    url('^register/$', RegisterView.as_view(), name="register"),
    url(r'^captcha/', include('captcha.urls')),
    url(r'^active/(?P<active_code>.*)$', ActiveUserView.as_view(), name="user_active"),
    url(r'^forget/$', ForgetPwdView.as_view(), name="forget_pwd"),
    url(r'^reset/(?P<active_code>.*)$', ResetView.as_view(), name="reset_pwd"),
]
```

password\_reset.htmlé¡µé¢å‡ºæ¥ä¹‹ååå°å¤„ç†çš„é€»è¾‘ï¼š

é¦–å…ˆpassword\_reset.htmlçš„form

```html
<form id="reset_password_form" action="{% url 'reset_pwd' %}" method="post">
            <ul>
                <li>
                    <span class="">æ–° å¯† ç  ï¼š</span>
                    <input type="password" name="password" id="pwd" placeholder="6-20ä½éä¸­æ–‡å­—ç¬¦">
                    <i></i>
                </li>
                <input type="hidden" value="{{ email }}">
                <li>
                    <span class="">ç¡®å®šå¯†ç ï¼š</span>
                    <input type="password" name="password2" id="repwd" placeholder="6-20ä½éä¸­æ–‡å­—ç¬¦">
                    <i></i>
                </li>
                <li class="button">
                    <input type="button" value="æäº¤" onclick="reset_password_form_submit()">
                </li>
            </ul>
            {% csrf_token %}
        </form>
```

formçš„å¤„ç†ï¼Œå†™åœ¨forms.pyä¸­

```python
class ModifyPwdForm(forms.Form):
    password1 = forms.CharField(required=True, min_length=5)
    password2 = forms.CharField(required=True, min_length=5)
```

ç„¶åæ˜¯ç”¨æˆ·ç‚¹å‡»æäº¤ä¹‹åçš„åå°å¤„ç†é€»è¾‘ï¼š

å°±æ˜¯postæ–¹æ³• 

import formæ–¹æ³• ModifyPwdForm

è¡¨å•å®ä¾‹åŒ–

å†™é€»è¾‘ä¹‹å‰è¦ç¡®ä¿ï¼Œhtml å’Œformåç§°ä¸€æ · password1 password2

```html
<li>
                    <span class="">æ–° å¯† ç  ï¼š</span>
                    <input type="password" name="password1" id="pwd" placeholder="6-20ä½éä¸­æ–‡å­—ç¬¦">
                    <i></i>
                </li>
                <input type="hidden" name="email" value="{{ email }}">
                <li>
                    <span class="">ç¡®å®šå¯†ç ï¼š</span>
                    <input type="password" name="password2" id="repwd" placeholder="6-20ä½éä¸­æ–‡å­—ç¬¦">
                    <i></i>
                </li>
```



```python
class ModifyPwdView(View):
    def post(self, request):
        modify_form = ModifyPwdForm(request.POST)
        if modify_form.is_valid():
            pwd1 = request.POST.get("password1", "")
            pwd2 = request.POST.get("password2", "")
            email = request.POST.get("email", "")
            if pwd1 != pwd2:
                return render(request, "password_reset.html", {"email": email, "msg": "å¯†ç ä¸ä¸€è‡´"})
            user = UserProfile.objects.get(email=email)
            user.password = make_password(pwd2)
            user.save()

            return render(request, "login.html")
        else:
            email = request.POST.get("email", "")
            return render(request, "password_reset.html", {"email": email, "modify_form": modify_form})
```



```python
from django.conf.urls import url, include
from django.contrib import admin
from django.views.generic import TemplateView
import xadmin
from users.views import LoginView, RegisterView, ActiveUserView, ForgetPwdView, ResetView, ModifyPwdView

urlpatterns = [
    url(r'^xadmin/', xadmin.site.urls),
    url('^$', TemplateView.as_view(template_name="index.html"), name="index"),
    # url('^login/$', TemplateView.as_view(template_name="login.html"), name="login")
    # url('^login/$', user_login, name="login")
    url('^login/$', LoginView.as_view(), name="login"),
    url('^register/$', RegisterView.as_view(), name="register"),
    url(r'^captcha/', include('captcha.urls')),
    url(r'^active/(?P<active_code>.*)$', ActiveUserView.as_view(), name="user_active"),
    url(r'^forget/$', ForgetPwdView.as_view(), name="forget_pwd"),
    url(r'^reset/(?P<active_code>.*)$', ResetView.as_view(), name="reset_pwd"),
    url(r'^modify_pwd/$', ModifyPwdView.as_view(), name="modify_pwd"),

]
```



```html
<form id="reset_password_form" action="{% url 'modify_pwd' %}" method="post">
            <ul>
                <li>
                    <span class="">æ–° å¯† ç  ï¼š</span>
                    <input type="password" name="password1" id="pwd" placeholder="6-20ä½éä¸­æ–‡å­—ç¬¦">
                    <i></i>
                </li>
                <input type="hidden" name="email" value="{{ email }}">
                <li>
                    <span class="">ç¡®å®šå¯†ç ï¼š</span>
                    <input type="password" name="password2" id="repwd" placeholder="6-20ä½éä¸­æ–‡å­—ç¬¦">
                    <i></i>
                </li>
                <li class="button">
                    <input type="button" value="æäº¤" onclick="reset_password_form_submit()">
                </li>
            </ul>
            {% csrf_token %}
        </form>
```

ä¿®æ”¹ä¸ºï¼š

```html
<form id="reset_password_form" action="{% url 'modify_pwd' %}" method="post">
```





























































